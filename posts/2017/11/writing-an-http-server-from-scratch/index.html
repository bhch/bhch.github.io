<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing an HTTP server from scratch - Bharat Chauhan</title>
    <link rel="stylesheet" href="https://bhch.github.io/theme/css/pure-min.css">
    <!--[if lte IE 8]>
      
        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-old-ie-min.css">
      
    <![endif]-->
    <!--[if gt IE 8]><!-->
      
        <link rel="stylesheet" href="https://bhch.github.io/theme/css/grids-responsive-min.css">
      
    <!--<![endif]-->
    <link rel="stylesheet" href="https://bhch.github.io/theme/css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:500" rel="stylesheet">

    <link rel="shortcut icon" href="https://bhch.github.io/favicon.png">
</head>
<body>
<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4" 
    >
        <div class="header">
            <img class="author-avatar" src="https://bhch.github.io/images/tyler.jpg">
            <h3 class="brand-title">
                <a href="https://bhch.github.io">
                    Bharat Chauhan
                </a>
            </h3>
            <p class="brand-tagline">A semi-regular technical blog where I post tutorials or                 write about new things I learn.</p>
            <button id="hamburger" class="hamburger hamburger--squeeze" type="button">
              <span class="hamburger-box">
                <span class="hamburger-inner"></span>
              </span>
            </button>
            <div id="sidebar-menu" class="sidebar-menu">
                <p><a href="/">home</a></p>
                <p><a href="/about/">about</a></p>
                <p><a href="/archive/">archive</a></p>
                <p><a href="http://bitbucket.org/bhch/">bitbucket</a></p>
                <p><a href="http://github.com/bhch/">github</a></p>
                <p><a href="/feeds/atom.xml">atom</a></p>
            </div>
        </div>
    </div>

    <div class="content pure-u-1 pure-u-md-3-4">
        <div class="pure-u-1 pure-u-md-5-6 post-container">
            <!-- A wrapper for all the blog posts -->
            <div class="posts">

<div class="announcement">
    <div class="title">ðŸ‘‹ Hello, reader!</div>
    <div class="body pure-g">
        <div class="pure-u-3-4 pure-u-md-3-4">
            <p>
                I'm building <a href="#"><strong>Butter Domains</strong></a>: a better
                domain registration service that we all deserve.
                <br/>
                Check it out at: <a href="#">www.butterdomains.com</a>.
            </p>
        </div>
        <div class="pure-u-1-4">
            <a href="#" class="img-link">
            <img src="https://www.butterdomains.com/static/logo-2.svg?v=4444e97af745f04a47b9099c0f3a91b145e37b92d445421c0eeb581682a4484d0d8c9cecc7a102aed95bcf0b75a3a22191e6c112cbf42e91f4eb3a161c52713e"/>
            </a>
        </div>
    </div>
</div>
<section class="post">
    <header class="post-header">

        <h1 class="post-title">Writing an HTTP server from scratch</h1>
<p class="post-meta">
    Thu 16 November 2017
        <strong>&nbsp; &middot; &nbsp;</strong> 
        updated Mon 19 October 2020

        <strong>&nbsp; &middot; &nbsp;</strong> 
        <a href="https://bhch.github.io/category/programming/" class="faded-link" >Programming</a>
        <strong>&nbsp; &middot; &nbsp;</strong>
        <span class="tags">
                <a href="https://bhch.github.io/tag/python/" class="tag">python</a>
                <a href="https://bhch.github.io/tag/http/" class="tag">http</a>
                <a href="https://bhch.github.io/tag/server/" class="tag">server</a>
        </span>
</p>
    </header>

    <div class="post-description">
        <h1 id="prelude">Prelude<a class="headerlink" href="#prelude" title="Permanent link">&para;</a></h1>
<p>This article will introduce you to the basics of HTTP servers and teach you 
how you can write one. We'll use the Python programming language to write our server.</p>
<p>Please note that this is a basic tutorial and, therefore, should not be taken as a 
guide for building a production level HTTP server.</p>
<h3 id="github-repo">GitHub repo<a class="headerlink" href="#github-repo" title="Permanent link">&para;</a></h3>
<p>You can find the code on Github and test it out: <strong><a href="https://github.com/bhch/crude-server">https://github.com/bhch/crude-server</a></strong>. </p>
<p>The code in the repo contains some extra modifications, but you'll figure those out 
when you read the source code. </p>
<h1 id="steps-to-create-an-http-server">Steps to create an HTTP server<a class="headerlink" href="#steps-to-create-an-http-server" title="Permanent link">&para;</a></h1>
<p>An HTTP server can be built in these two steps:</p>
<h4 id="1-create-a-tcp-server">1. Create a TCP server<a class="headerlink" href="#1-create-a-tcp-server" title="Permanent link">&para;</a></h4>
<p>HTTP is built on top of TCP (Transmission Control Protocol), so we will need to
create a program capable of sending and receiving data through a TCP socket. 
Knowledge about the TCP protocol is not required but familiarity with Python's 
<code>socket</code> library is. Go through <code>socket</code> library's <a href="https://docs.python.org/3/howto/sockets.html">docs</a>, or 
read the <a href="https://pymotw.com/3/socket/">PyMOTW</a> page for good examples.</p>
<h4 id="2-teach-our-tcp-server-the-http-protocol">2. Teach our TCP server the HTTP protocol.<a class="headerlink" href="#2-teach-our-tcp-server-the-http-protocol" title="Permanent link">&para;</a></h4>
<p>At this point our TCP server doesn't understand HTTP. To convert it from a TCP 
server to an HTTP server all we need to do is <em>teach</em> it the HTTP protocol.
You need to have some basic knowledge about the HTTP protocol, 
for example, the structure of HTTP requests and responses. A good starting 
point to learn about the HTTP protocol is <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">Mozilla's docs on HTTP</a>.</p>
<p>That's it. That's all it takes to write an HTTP server.</p>
<h1 id="step-1-creating-a-tcp-server">Step 1:  Creating a TCP server<a class="headerlink" href="#step-1-creating-a-tcp-server" title="Permanent link">&para;</a></h1>
<p><img alt="HTTP is built on top of TCP" src="/images/tcp-socket.png"></p>
<p>Since HTTP works through a TCP socket, we'll start by writing a simple TCP server.
We will use Python's <code>socket</code> library for this.</p>
<h2 id="12-a-simple-echo-server">1.2 A simple Echo server<a class="headerlink" href="#12-a-simple-echo-server" title="Permanent link">&para;</a></h2>
<p>Firstly, let's create a simple version of our TCP server: an Echo server. An 
Echo server is a program that returns the data that it receives, nothing less, 
nothing more.</p>
<p>Start by creating a file called <code>main.py</code> for our code:</p>
<div class="highlight"><pre><span></span><span class="c1"># main.py </span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="k">class</span> <span class="nc">TCPServer</span><span class="p">:</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span> <span class="c1"># address for our server</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">8888</span> <span class="c1"># port for our server</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create a socket object</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

        <span class="c1"># bind the socket object to the address and port</span>
        <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="c1"># start listening for connections</span>
        <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Listening at&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># accept any new connection</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Connected by&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>

            <span class="c1"># read the data sent by the client</span>
            <span class="c1"># for the sake of this tutorial, </span>
            <span class="c1"># we&#39;ll only read the first 1024 bytes</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

            <span class="c1"># send back the data to client</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># close the connection</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">TCPServer</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>Read the comments in the code for explanation.</p>
<p>To test this server, we can create a TCP client but that won't be necessary. We 
can just use our web browser.</p>
<p>First, run the server like this:</p>
<div class="highlight"><pre><span></span>$ python main.py
</pre></div>


<p>Now, visit <code>127.0.0.1:8888</code> from your browser. Your browser will send an HTTP request 
to our TCP server. Since our server is an Echo server, it will return the data 
that our browser sends it back to the browser. </p>
<p>You'll see a response from our server something like this:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">127.0.0.1:8888</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 &lt;...long string...&gt;</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, sdch</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-GB,en-US;q=0.8,en;q=0.6</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">__utma=889955431.966891923.1514504807.15045637810 &lt;...long string...&gt;</span>
</pre></div>


<h2 id="13-modifying-the-echo-server">1.3 Modifying the Echo server<a class="headerlink" href="#13-modifying-the-echo-server" title="Permanent link">&para;</a></h2>
<p>Our Echo server is very primitive and not very helpful. We'll now modify it such 
that it can be used as a base for our HTTP server.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TCPServer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8888</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Listening at&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Connected by&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handles incoming data and returns a response.</span>
<span class="sd">        Override this in subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>


<p>The modifications we've done are:</p>
<ol>
<li>We've created an <code>__init__</code> function that takes to arguments - <code>host</code> and <code>port</code>. 
  We've set the default values for them as they were in the previous example. The 
  reason we did this is now we can bind our server to different addresses and ports
  if we so desired.</li>
<li>We've also created a new method called <code>handle_request</code> which will come in handy 
 when we subclass the <code>TCPServer</code> class. You might have noticed the code inside the 
 <code>while</code> loop has also changed. The new code sends the data to <code>handle_request</code> method 
 which will then returns a response. Currently, the <code>handle_request</code> method does nothing 
 but we'll create a subclass and override this method to add some actual functionality.</li>
</ol>
<h1 id="step-2-teaching-the-http-protocol-to-our-tcp-server">Step 2: Teaching the HTTP protocol to our TCP server<a class="headerlink" href="#step-2-teaching-the-http-protocol-to-our-tcp-server" title="Permanent link">&para;</a></h1>
<p><img alt="HTTP protocol" src="/images/http-speak.png"></p>
<p>Instead of implementing the HTTP protocol in the <code>TCPServer</code> class, we'll subclass it 
and implement the protocol in the subclass. Let's start by handling the incoming 
requests by overriding the <code>handle_request</code> method. Add this to <code>main.py</code> file:</p>
<div class="highlight"><pre><span></span><span class="c1"># main.py</span>

<span class="c1"># ... previous code ...</span>

<span class="hll"><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Request received!&quot;</span> <span class="c1"># send bytes, not string</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="hll">    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">()</span>
</span>    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<blockquote>
<p><strong>Important:</strong> Python's <code>socket</code> library receives and sends data as <code>bytes</code>, not as <code>str</code> (string). 
That's why we're using the <code>b""</code> prefix with our strings. If we don't do that, 
we'll get an error.</p>
</blockquote>
<p>Now <strong>restart the server</strong> by running the <code>main.py</code> file. Visit <code>127.0.0.1:8888</code> from your browser and 
you should see <code>Request received!</code> message on the screen.</p>
<p>Although, it's not a valid HTTP response yet. An HTTP response is made up of 
the following parts:</p>
<ol>
<li>The response line a.k.a status line (it's the first line)</li>
<li>Response headers (optional)</li>
<li>A blank line</li>
<li>Response body (optional)</li>
</ol>
<p>An example:</p>
<div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>            <span class="c1"># The first line is called the response line </span>
<span class="n">Server</span><span class="p">:</span> <span class="n">Tornado</span><span class="o">/</span><span class="mf">4.3</span>        <span class="c1"># Response header</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Oct</span> <span class="mi">2017</span>     <span class="c1"># Response header</span>
<span class="n">Content</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>    <span class="c1"># Response header</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">13</span>         <span class="c1"># Response header</span>
                           <span class="c1"># Blank line</span>
<span class="n">Hello</span><span class="p">,</span> <span class="n">world</span><span class="err">!</span>              <span class="c1"># Response body</span>
</pre></div>


<p>The response line and the headers contain informaton for the browser. They are not 
shown to the client. The response body contains the data which the browser displays 
on the screen for the client.</p>
<p>The blank line plays a very important role in HTTP and many other protocols. It helps 
to seperate the headers and response body. Without it, there's no way for browsers 
to tell which part of the response should be shown to the user.</p>
<p>For a better understanding of HTTP responses, <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Messages">read the docs on Mozilla</a>.</p>
<p>Let's make our server return a valid response this time:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">response_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">&quot;</span>

        <span class="n">blank_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>

        <span class="n">response_body</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Request received!&quot;&quot;</span>

        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">response_line</span><span class="p">,</span> <span class="n">blank_line</span><span class="p">,</span> <span class="n">response_body</span><span class="p">])</span>
</pre></div>


<p>The <code>\r\n</code> characters are line break characters. They are present at the end of 
every line in an HTTP response except the response body. They are useful for 
browsers to tell headers and response line apart.</p>
<p>This time our server will return a valid HTTP response.</p>
<h2 id="21-headers">2.1 Headers<a class="headerlink" href="#21-headers" title="Permanent link">&para;</a></h2>
<p>Our server doesn't return any headers yet. Let's make it return some.</p>
<p>Headers contain some general information about the website and the current page, 
such as the name of the server, or the content type of the response, or any other 
information that might be useful for the browser but not so much for the user.</p>
<p>First, let's give our server a name. I'll call it <code>Crude Server</code> because it's 
crude, raw and a basic HTTP server.</p>
<p>Second, instead of returning plain text, we'll return HTML in the response. For that, 
we'll also have to send the <code>Content-Type</code> header to let the browser know that this 
is an HTML response.</p>
<p>Now, let's make our server return this information in headers:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">response_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">&quot;</span>

<span class="hll">        <span class="n">headers</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span><span class="hll">            <span class="sa">b</span><span class="s2">&quot;Server: Crude Server</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> 
</span><span class="hll">            <span class="sa">b</span><span class="s2">&quot;Content-Type: text/html</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class="hll">        <span class="p">])</span>
</span>
        <span class="n">blank_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>

<span class="hll">        <span class="n">response_body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;&lt;html&gt;</span>
</span><span class="hll"><span class="s2">            &lt;body&gt;</span>
</span><span class="hll"><span class="s2">            &lt;h1&gt;Request received!&lt;/h1&gt;</span>
</span><span class="hll"><span class="s2">            &lt;body&gt;</span>
</span><span class="hll"><span class="s2">            &lt;/html&gt;</span>
</span><span class="hll"><span class="s2">        &quot;&quot;&quot;</span>
</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">response_line</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">blank_line</span><span class="p">,</span> <span class="n">response_body</span><span class="p">])</span>
</pre></div>


<h2 id="22-refining-our-http-server">2.2 Refining our HTTP server<a class="headerlink" href="#22-refining-our-http-server" title="Permanent link">&para;</a></h2>
<p>We are returning the HTTP response by manually writing it. It's not 
very convenient. </p>
<p>Let's create a few methods to compile response line, headers and response:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Server&#39;</span><span class="p">:</span> <span class="s1">&#39;CrudeServer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/html&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">status_codes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">200</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span>
        <span class="mi">404</span><span class="p">:</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handles the incoming request.</span>
<span class="sd">        Compiles and returns the response</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="hll">        <span class="n">response_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_line</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">response_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="p">()</span>
</span>
        <span class="n">blank_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>

        <span class="n">response_body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">                &lt;body&gt;</span>
<span class="s2">                    &lt;h1&gt;Request received!&lt;/h1&gt;</span>
<span class="s2">                &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">response_line</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">blank_line</span><span class="p">,</span> <span class="n">response_body</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">response_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns response line&quot;&quot;&quot;</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_codes</span><span class="p">[</span><span class="n">status_code</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;HTTP/1.1 </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1"># call encode to convert str to bytes</span>

    <span class="k">def</span> <span class="nf">response_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns headers</span>
<span class="sd">        The `extra_headers` can be a dict for sending </span>
<span class="sd">        extra headers for the current response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># make a local copy of headers</span>

        <span class="k">if</span> <span class="n">extra_headers</span><span class="p">:</span>
            <span class="n">headers_copy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_headers</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers_copy</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">headers_copy</span><span class="p">[</span><span class="n">h</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">headers</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1"># call encode to convert str to bytes</span>
</pre></div>


<p>So, we've created two new method: <code>response_line()</code> and <code>response_headers()</code> which will 
compile the response line and headers for us. The comments in the code will help 
clarify what's going on. </p>
<h2 id="23-status-codes">2.3 Status codes<a class="headerlink" href="#23-status-codes" title="Permanent link">&para;</a></h2>
<p>As you can see in the code above, we've created a dictionary of status codes in 
<code>HTTPServer</code> class. But there are only 2 status codes in our dictionary. I've done that 
intentionally to keep the code shorter. You can implement all the status codes 
in your local version of the code. See <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">Mozilla's docs</a> for a list of all 
the HTTP statuses.</p>
<p>You can use Python's <code>http.client</code> from the standard library. It has a dictionary 
of all HTTP statuses which can be accessed from <a href="https://docs.python.org/3/library/http.client.html#http.client.responses"><code>http.cleint.responses</code></a>.</p>
<h2 id="24-http-requests">2.4 HTTP requests<a class="headerlink" href="#24-http-requests" title="Permanent link">&para;</a></h2>
<p>Currently, our server just sends a single response for every request. To make it 
more functional, we'll need to read the requests of the client and send them the 
content that they request. </p>
<p>Let's first understand what's an HTTP request.</p>
<p>An HTTP request is made up of the following parts:</p>
<ol>
<li>The request line (it's the first line)</li>
<li>Request headers (optional)</li>
<li>A blank line</li>
<li>Request body (optional)</li>
</ol>
<p>An example of typical HTTP request:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/index.html</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">example.com</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0</span>
</pre></div>


<p>In case you haven't noticed, in the example above, the request doesn't have a body, 
just a Request line, headers and a blank line at the end (although, it's not visible here).</p>
<p>The most important part of an HTTP request is the Request line. Let's discuss this 
further below.</p>
<h3 id="241-request-line">2.4.1 Request line<a class="headerlink" href="#241-request-line" title="Permanent link">&para;</a></h3>
<p>The first line of an HTTP request is called the Request line. It consists of 4 parts:</p>
<div class="highlight"><pre><span></span>    GET    /index.html      HTTP/1.1           \r\n
    \_/    \_________/      \______/          \____/
     |          |               |                |
  Method       URI        HTTP version       Line break
</pre></div>


<ol>
<li><code>Method</code> tells the server what action the client wants to perform on the <code>URI</code>.
  For example, <code>GET</code> method means the client wants the server to send him the page at 
  the given <code>URI</code>. The <code>POST</code> method means the client wants to send some data to the 
  server at the given <code>URI</code>.</li>
<li><code>URI</code> stands for Uniform Resource Identifier. This tells the server on which 
 resource or page or anything else the client wants to perform the request.</li>
<li><code>HTTP version</code> is the version of HTTP the client supports or wants the server to use 
 for the response. The most widely used version of HTTP is 1.1.</li>
<li><code>Line break</code> - this tells the server that the request line has ended and the 
 request headers follow after this line.</li>
</ol>
<p>I've covered basics about the HTTP requests. You can read more about it <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Messages">here</a>.</p>
<h2 id="25-parsing-requests">2.5 Parsing requests<a class="headerlink" href="#25-parsing-requests" title="Permanent link">&para;</a></h2>
<p>So far, we've rendered a response without actually <em>reading</em> the requests, which 
means our server is no good yet. We'll have to write some more code to parse the 
incoming requests to know what HTTP method is used, to know what URI is requested, 
etc.</p>
<p>Let's write a simple request parser. We'll create a class called <code>HTTPRequest</code>. 
Add the following to the <code>main.py</code> file:</p>
<div class="highlight"><pre><span></span><span class="c1"># main.py</span>

<span class="c1"># ...</span>
<span class="c1"># ... class TCPServer ...</span>
<span class="c1"># ...</span>
<span class="c1"># ... class HTTPServer ...</span>
<span class="c1"># ...</span>


<span class="k">class</span> <span class="nc">HTTPRequest</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_version</span> <span class="o">=</span> <span class="s2">&quot;1.1&quot;</span> <span class="c1"># default to HTTP/1.1 if request doesn&#39;t provide a version</span>

        <span class="c1"># call self.parse() method to parse the request data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">request_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">words</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="c1"># call decode to convert bytes to str</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># we put this in an if-block because sometimes </span>
            <span class="c1"># browsers don&#39;t send uri for homepage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="c1"># call decode to convert bytes to str</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_version</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


<span class="c1"># ... </span>
<span class="c1"># ... if __name__ == &#39;__main__&#39; ...</span>
<span class="c1"># ...</span>
</pre></div>


<p>The above code only parses the Request line. We don't have to worry about request headers, 
or request body for this tutorial.</p>
<h2 id="26-implementing-http-request-methods">2.6 Implementing HTTP request methods<a class="headerlink" href="#26-implementing-http-request-methods" title="Permanent link">&para;</a></h2>
<p>Our server can't distinguish between different request methods. We are serving 
the same response for <code>GET</code> or <code>POST</code> or <code>OPTIONS</code> or any other request method. </p>
<p>We'll create one method in <code>HTTPServer</code> class&mdash;<code>handle_GET()</code> to handle <code>GET</code> requests.</p>
<p>For a <code>GET</code> request, a server returns the requested resource. Say, if a request 
comes in like <code>GET /index.html</code>, the server will send the contents of <em>index.html</em> 
file in the response body.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="c1"># ... other code ...</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="hll">        <span class="c1"># create an instance of `HTTPRequest`</span>
</span><span class="hll">        <span class="n">request</span> <span class="o">=</span> <span class="n">HTTPRequest</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="c1"># now, look at the request method and call the </span>
</span><span class="hll">        <span class="c1"># appropriate handler</span>
</span><span class="hll">        <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">return</span> <span class="n">response</span>
</span>
<span class="hll">    <span class="k">def</span> <span class="nf">handle_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span class="hll">        <span class="c1"># We&#39;ll write this method a little later</span>
</span><span class="hll">        <span class="k">pass</span>
</span></pre></div>


<p>Okay, we've created one handler to handle <code>GET</code> requests. In this tutoial, we won't implement handlers 
for other request types. But the <a href="https://github.com/bhch/crude-server">Github repo</a> contains handler for <code>OPTIONS</code> requests as well.</p>
<h3 id="261-sending-501-response">2.6.1 Sending 501 Response<a class="headerlink" href="#261-sending-501-response" title="Permanent link">&para;</a></h3>
<p><code>501</code> HTTP responses mean <code>Not Implemented</code>. They are used for telling the client that the 
server does't support the requested method type.</p>
<p>Since our server will only handle <code>GET</code> requests, it's a good idea to send <code>501</code> response
for other request methods such as <code>POST</code> or <code>PUT</code>.</p>
<p>So, let's modify our server to send a <code>501</code> response:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="c1"># ... headers ...</span>

    <span class="n">status_codes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">200</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span>
        <span class="mi">404</span><span class="p">:</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span>
<span class="hll">        <span class="mi">501</span><span class="p">:</span> <span class="s1">&#39;Not Implemented&#39;</span><span class="p">,</span>
</span>    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HTTPRequest</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="hll">        <span class="k">try</span><span class="p">:</span>
</span><span class="hll">            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</span><span class="hll">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span class="hll">            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTTP_501_handler</span>
</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>

<span class="hll">    <span class="k">def</span> <span class="nf">HTTP_501_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span class="hll">        <span class="n">response_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_line</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">501</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">response_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">blank_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">response_body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&lt;h1&gt;501 Not Implemented&lt;/h1&gt;&quot;</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">response_line</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">blank_line</span><span class="p">,</span> <span class="n">response_body</span><span class="p">])</span>
</span>
    <span class="k">def</span> <span class="nf">handle_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># We&#39;ll write this method a little later</span>
        <span class="k">pass</span>
</pre></div>


<p>Now, if a rquest comes in with any method other than <code>GET</code>, our server 
will appropriately return a <code>501</code> response.</p>
<h2 id="27-handling-get-requests">2.7 Handling <code>GET</code> requests<a class="headerlink" href="#27-handling-get-requests" title="Permanent link">&para;</a></h2>
<p>Let's start fully implementing the <code>handle_GET()</code> method. Now we'll serve content 
from actual HTML and other files.</p>
<h3 id="271-serving-content-from-files">2.7.1 Serving content from files<a class="headerlink" href="#271-serving-content-from-files" title="Permanent link">&para;</a></h3>
<p>Let's serve some content from files instead of from strings as we've been doing until now. </p>
<p>First, let's create a couple of files - <em>"index.html"</em> and <em>"hello.html"</em>. </p>
<p>Now, if a request comes in like <code>GET /index.html</code>, we'll serve the <em>index.html</em> file. If 
a request comes in like <code>GET /hello.html</code>, we'll serve the <em>hello.html</em> file. </p>
<p>Keep both these files in the same directory as <code>main.py</code>.</p>
<p><em>index.html</em>:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Index page<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Index page<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This is the index page.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>


<p><em>hello.html</em>: </p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hello page<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Hello page<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This is the hello page.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>


<p>We'll also send a <code>404 Not Found</code> response if a requested file doesn't exist.</p>
<p>Now, let's modify the handler method to serve content according to the request URI. </p>
<div class="highlight"><pre><span></span><span class="hll"><span class="kn">import</span> <span class="nn">os</span> <span class="c1"># remember to import os</span>
</span><span class="kn">import</span> <span class="nn">socket</span>


<span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="c1"># ... other code ...</span>

    <span class="k">def</span> <span class="nf">handle_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="c1"># remove the slash from the request URI</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">response_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_line</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

            <span class="n">response_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">response_body</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_line</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
            <span class="n">response_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="p">()</span>
            <span class="n">response_body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&lt;h1&gt;404 Not Found&lt;/h1&gt;&quot;</span>

        <span class="n">blank_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">response_line</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">blank_line</span><span class="p">,</span> <span class="n">response_body</span><span class="p">])</span>
</pre></div>


<p>Now, <strong>restart the server</strong> and visit <code>127.0.0.1:8888/index.html</code> and you should 
see the response containing the contents of <em>index.html</em> file. </p>
<p>Also, try and visit a random url like <code>127.0.0.1:8888/blahblah.html</code> and you should 
get the <code>404 Not Found</code> response.</p>
<h2 id="28-serving-images-and-other-media">2.8 Serving images and other media<a class="headerlink" href="#28-serving-images-and-other-media" title="Permanent link">&para;</a></h2>
<p>To serve images, or videos, or any other media a server must send a proper 
<code>Content-Type</code> header to the browser to tell that the browser about what kind of 
content is being served so it can render the content appropriately.</p>
<p>Our server, as it is right now, can serve images, or videos. You can even try it - 
put an image file next to the previously created HTML files and make a request for 
that image from the browser - <code>127.0.0.1:8888/picture.png</code> and you should see some 
random gibberish text on your screen. This is happening because our server is sending 
the image with <code>Content-Type: text/html</code> header. That is why the  browser is not rendering 
it as an image.</p>
<p>The <code>Content-Type</code> of a file is also called <a href="https://en.wikipedia.org/wiki/Media_type">MIME Type</a>. We'll be using Python's 
<code>mimetypes</code> library to know a file's MIME type from it's extension. We can do it 
manually, but there are hundreds of different file types - <em>"jpg, png, mp4, mp3, svg ..."</em>, 
so, why not use a library to make it easier.</p>
<p><code>mimetypes</code> library is included in Python's standard library, so there's no need to install 
anything.</p>
<p>Let's modify our server to send proper <code>Content-Type</code> header for different files. </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="hll"><span class="kn">import</span> <span class="nn">mimetypes</span> <span class="c1"># remember to import mimetypes</span>
</span>

<span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="c1"># ... other code ...</span>

    <span class="k">def</span> <span class="nf">handle_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">response_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_line</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="hll">            <span class="c1"># find out a file&#39;s MIME type</span>
</span><span class="hll">            <span class="c1"># if nothing is found, just send `text/html`</span>
</span><span class="hll">            <span class="n">content_type</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;text/html&#39;</span>
</span><span class="hll">
</span><span class="hll">            <span class="n">extra_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">}</span>
</span><span class="hll">            <span class="n">response_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="p">(</span><span class="n">extra_headers</span><span class="p">)</span>
</span>
           <span class="c1"># ... rest of the code ...</span>
</pre></div>


<p>Now, put an image next to <em>index.html</em>. </p>
<p><strong>Restart the server</strong> and make a request for it from your browser. </p>
<p>You should see the image rendered properly. You can also try and embed the image 
in <em>index.html</em> file using <code>&lt;img src="image-name.png"&gt;</code> and then request the <code>/index.html</code>
page. You should see the image there, too.</p>
<h1 id="and-its-done">And it's done<a class="headerlink" href="#and-its-done" title="Permanent link">&para;</a></h1>
<p>We've built our server! Well, at least a minimal server for learning purpose. Now you 
can play around with it&mdash;try and implement more request methods, or more headers. </p>
<p>Also, see the code in the supplementary <a href="https://github.com/bhch/crude-server">Github repo</a>. It contains some imporovements 
to the code, more comments and information.</p>
<p>Hopefully, the way HTTP and HTTP servers work is clear to you now.</p>
<h1 id="taking-our-server-to-the-next-level">Taking our server to the next level<a class="headerlink" href="#taking-our-server-to-the-next-level" title="Permanent link">&para;</a></h1>
<p>We've only scratched the surface of the HTTP protocol and it's workings. And 
the server written in this tutorial is far from good. But if you want to improve 
the server you can see the following checkpoints that almost every production 
level server implements:</p>
<ol>
<li><strong>Implement full HTTP</strong>:<br>
 Our server only supports one method&mdash;<code>GET</code>&mdash;and a few headers. It 
 has no support for Cookies, or caching. A good starting point towards a production 
 ready server would be to implement the full HTTP protocol. You can start by reading 
 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">Mozilla's web docs</a> and implementing all the HTTP features one by one.</li>
<li><strong>Serving multiple clients</strong>:<br>
 Currently, our server only serves one client at a time. You can make it serve 
 more than one client at a time by multi-threading. But not all servers use 
 multi-threading. There are event driven servers which use a different approach. 
 Read about the Tornado web server.</li>
<li><strong>WSGI support</strong>:<br>
 Currently, Python frameworks like Django and Flask won't work with our 
 server. The only way to make our server work with them is by implementing WSGI. 
 What is WSGI? Here's a <a href="http://lucumr.pocoo.org/2007/5/21/getting-started-with-wsgi/">tutorial by Armin Ronacher</a>.</li>
<li><strong>Daemon mode</strong>:<br>
 Running a server in daemon mode means that running it as a background process. 
 Currently, our server doesn't run in background. So, if we run it and then 
 close the terminal, our server process will also stop. You can use tools like 
 <a href="http://supervisord.org/">supervisord</a> to make the server run in daemon mode. </li>
<li><strong>Logging</strong>:<br>
 Logging is a very import feature of servers. It means writing logs to a file 
 in the event of say, an error occurs, like a <code>404</code> error, or a <code>500</code> server error. 
 Servers also write access logs for every request which contain information about the
 IP Address of the the client, the page requested and the time.</li>
<li><strong>Configuration support</strong>:<br>
 Our server doesn't support configuration, for example we can't tell our server 
 which files or directories to server, where to find files, etc. This way, we can 
 map a file to a different URL, which means we can serve <code>hello.html</code> file from a 
 URL like <code>/goodbye</code>.</li>
<li><strong>Serving large files</strong>:<br>
 Our server is capable of serving videos. But not very large videos. The reason 
 is before serving files to the client we read the whole file in the memory by 
 using <code>f.read()</code> (see the code in <code>handle_GET</code> method above). So, if you try to 
 serve large video file, say about 3 GB, and you only have 2 GB of RAM, your server 
 will crash. The way servers safely serve large files is by reading and writing 
 only a smart part (around 10 - 20 MB) of the file at a time. This is done in a 
 loop which will run until the whole file is read and written to the response.
 This technique is called <em>chunking</em>.</li>
<li><strong>Security</strong>:<br>
 In this blog post, we've talked about almost everything HTTP related, except for 
 security. This is a very delicate topic and it's never permanent - you'll have to 
 constantly keep working to keep your code secure. A good starting point to read 
 about server security would be <a href="https://wiki.mozilla.org/Security/Guidelines/Web_Security">this page by Mozilla</a>. But the best way to 
 keep a software secure is by making it open source. That way if someone finds a 
 security issue, they might notify you or even write a patch themselves. Why do you 
 think almost every web server is open source? This is why.</li>
</ol>
<h1 id="thats-it">That's it<a class="headerlink" href="#thats-it" title="Permanent link">&para;</a></h1>
<p>You now know about the internal workings of an HTTP server. </p>
<p>In case there are errors in the code, or any other mistakes, please let me know. </p>
    </div>

    <hr/>
<div class="announcement">
    <div class="title">ðŸ‘‹ Hello, reader!</div>
    <div class="body pure-g">
        <div class="pure-u-3-4 pure-u-md-3-4">
            <p>
                I'm building <a href="#"><strong>Butter Domains</strong></a>: a better
                domain registration service that we all deserve.
                <br/>
                Check it out at: <a href="#">www.butterdomains.com</a>.
            </p>
        </div>
        <div class="pure-u-1-4">
            <a href="#" class="img-link">
            <img src="https://www.butterdomains.com/static/logo-2.svg?v=4444e97af745f04a47b9099c0f3a91b145e37b92d445421c0eeb581682a4484d0d8c9cecc7a102aed95bcf0b75a3a22191e6c112cbf42e91f4eb3a161c52713e"/>
            </a>
        </div>
    </div>
</div>    
</section>

    <div class="comments">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'bhch-blog';
        var disqus_identifier = 'posts/2017/11/writing-an-http-server-from-scratch/';
        var disqus_url = 'https://bhch.github.io/posts/2017/11/writing-an-http-server-from-scratch/';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//bhch-blog.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
            </div>

<div class="footer">
    <p>
        &copy; 
        <!-- Use JS to render year of copyright-->
        <script>document.write(new Date().getFullYear())</script>

                <!-- plain text -->
                Bharat Chauhan

                <!-- middot spacer-->
                &nbsp;&middot;&nbsp;



                <!-- plain text -->
                content available under



                <!-- link -->
                <a href="https://creativecommons.org/licenses/by/4.0/">cc-by-4.0</a>

            <!-- middot spacer-->
            &nbsp;&middot;&nbsp;

            powered by <a href="http://blog.getpelican.com">Pelican</a> and 
            <a href="https://github.com/bhch/beak/">beak</a>
    </p>
</div>        </div>
    </div>
</div>
<script>
// Sidebar Hamburger Menu
var hamburger = document.getElementById("hamburger");
var menu = document.getElementById("sidebar-menu");

hamburger.addEventListener("click", function() {
    // Toggle class "is-active"
    if (hamburger.className == "hamburger hamburger--squeeze") {
        hamburger.className = "hamburger hamburger--squeeze is-active";
    } else {
        hamburger.className = "hamburger hamburger--squeeze";
    }
    // Do something else, like open/close menu
    if (menu.className == "sidebar-menu") {
        menu.className = "sidebar-menu open";
    } else {
        menu.className = "sidebar-menu";
    }
});
</script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-94030773-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>